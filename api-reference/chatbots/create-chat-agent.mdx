---
title: Create Chat Chat Agent
openapi: "api-reference/openapi.json POST /chat-chat agent"
---

# Create Chat Chat Agent

The chat chat agent creation system allows users to create and configure AI chat chat agents with comprehensive settings including basic details, configuration, knowledge base, calling numbers, denied words, dispositions, guardrails, and metadata. The system supports both creating new chat chat agents and updating existing ones through a single unified endpoint.

## API Endpoint

**Endpoint:** `POST /api/chat agent/createchat agentorupdate`

**Authentication:** Requires Super Admin authentication (`checkSuperAdmin` middleware)

**Route File:** `src/routes/chat agentBuild.js`

**Controller:** `src/controllers/chat agentbuild/chat agentController.js` - `createOrUpdateCompleteChat Agent`

## Request Structure

The endpoint accepts a `multipart/form-data` request with the following structure:

```json
{
  "basic_details": {
    "chat agent_id": 123,                    // Optional: Required for updates
    "chat agent_name": "Customer Support",   // Required for new chat agents
    "description": "Chat Agent description",
    "category": 1,
    "purpose": 1,
    "chat agent_type": 1,                    // 1=Voice, 2=Chat, 3=Telephony, 4=General
    "chatbot_name": "Support Bot",
    "chatbot_welcome_message": "Welcome!",
    "chatbot_image": "image_url",       // Can be uploaded as file
    "chat agent_privacy": 0,                 // 0=Private, 1=Public
    "chat agent_prompt": "You are a helpful assistant...",
    "voice_id": "KYiVPerWcenyBTIvWbfY",
    "voice_provider": 1,
    "transcriber_provider": 2,
    "transcriber_language": "en",
    "tone": "professional",
    "style": "conversational",
    "instruction_sensitivity": "medium"
  },
  "configuration": {
    "chat agent_id": 123,                    // Required
    "context_awareness": true,
    "memory_recall": true,
    "sentiment_analysis": true,
    "interruption_handling": true,
    "chat agent_terminate_instruction": "...",
    "chat agent_terminate_messages": "..."
  },
  "knowledge_base": {
    "chat agent_id": 123,                    // Required
    "tools": [
      { "id": 1, "isEnabled": true }
    ],
    "sub_chat agents": [
      { "id": 2, "isEnabled": true }
    ],
    "text_knowledge_bases": [
      { "name": "KB1", "content": "..." }
    ]
  },
  "phone_numbers": ["+1234567890"],
  "denials": {
    "chat agent_id": 123,
    "denied_words": ["word1", "word2"],
    "denied_topics": ["topic1", "topic2"]
  },
  "dispositions_config": {
    "dispositions": [...]
  },
  "guardrails": {
    "chat agent_id": 123,
    ...
  },
  "metadata_config": {
    "metadata_input": ["field1", "field2"],
    "metadata_output": ["field1", "field2"]
  }
}
```

**File Uploads:**
- `basic_details[chatbot_image]` - Chatbot image file
- Knowledge base files (PDF, DOC, DOCX, XLSX, CSV) - Up to 3 files, max 10MB each

## Process Flow

The chat agent creation/update process follows these steps in sequence:

### 1. Transaction Initialization

- A database transaction is started to ensure atomicity
- All operations are performed within this transaction
- If any step fails, the entire operation is rolled back

### 2. Basic Details Processing

**Function:** `createOrUpdateChat Agent(req, transaction)`

**Location:** ```177:509:src/controllers/chat agentbuild/chat agentController.js```

#### For New Chat Agents:

1. **Validation:**
   - Validates `chat agent_name` is provided
   - Checks for duplicate chat agent names in the workspace
   - Auto-increments name if duplicate found (e.g., "Chat Agent Name (1)")

2. **Category Processing:**
   - If category ID is provided, fetches category description from predefined lists
   - Stores category information as JSON

3. **Chat Agent Data Construction:**
   - Builds chat agent data object with provided fields
   - Sets default values:
     - `AGENT_MODEL`: 11
     - `MODEL_VERSION`: 55
     - `AGENT_PRIVACY`: 0 (Private)
     - `STATUS`: 3
   - Sets default voice ID if not provided: `"KYiVPerWcenyBTIvWbfY"` (Sia - Friendly Customer Care Chat Agent)
   - Sets default transcriber provider: 2
   - Sets default transcriber model: 16
   - Sets default voice provider: 1

4. **Chat Agent Creation:**
   - Creates chat agent record in `Chat AgentDetails` table
   - Generates unique `AGENT_UID` using UUID v4
   - Sets `CREATED_BY` and `CREATED_ON` timestamps

5. **Token Generation:**
   - Generates JWT token for chat agent authentication
   - Token payload includes:
     - `AGENT_ID`
     - `USER_ID`
     - `COMPANY_ID`
     - `WORKSPACE_ID`
     - `CREATED_ON`
     - `AUTH_UPDATE_AT`
   - Updates chat agent record with generated token

6. **Change Tracking:**
   - Tracks chat agent creation in change history

#### For Existing Chat Agents (Updates):

1. **Validation:**
   - Validates `chat agent_id` is provided
   - Fetches existing chat agent record

2. **Chat Agent Behavior Handling:**
   - Merges behavior fields (tone, style, instruction_sensitivity) with existing values
   - Preserves existing behavior if not all fields are updated

3. **Token Refresh:**
   - Retrieves or generates new chat agent token

4. **Update Processing:**
   - Updates chat agent record with new data
   - Tracks changes in change history

### 3. Chatbot Image Upload

**Location:** ```2328:2336:src/controllers/chat agentbuild/chat agentController.js```

- Extracts chatbot image from uploaded files
- Uploads to S3/cloud storage with path: `{company_id}/chat agent/chatbot_image/{chat agent_id}`
- Updates `basic_details.chatbot_image` with file directory path
- Removes image file from `req.files` array (to prevent it from being processed as knowledge base file)

### 4. Configuration Update

**Function:** `updateChat AgentConfig(req, transaction)`

**Location:** ```606:850:src/controllers/chat agentbuild/chat agentController.js```

**Process:**
1. Validates `chat agent_id` is provided
2. Checks if chat agent exists
3. Finds or creates `Chat AgentConfiguration` record
4. Updates configuration fields:
   - Context awareness
   - Memory recall
   - Sentiment analysis
   - Interruption handling
   - Voice settings
   - Chat Agent terminate instructions
   - Ambient noise detection
   - And other configuration options
5. Tracks configuration changes in change history

### 5. Knowledge Base Update

**Function:** `updateChat AgentKnowledgebase(req, transaction)`

**Location:** ```858:1205:src/controllers/chat agentbuild/chat agentController.js```

**Process:**
1. **Validation:**
   - Validates `chat agent_id` is provided
   - Checks chat agent exists and is not deleted

2. **Training Status Reset:**
   - Sets chat agent `TRAINED` status to 0 (not trained)

3. **Tools and Sub-chat agents:**
   - Processes tools array (TYPE: 1)
   - Processes sub-chat agents array (TYPE: 2)
   - Stores in `Chat AgentAppTools` table
   - Updates existing tools/sub-chat agents or creates new ones

4. **File Knowledge Bases:**
   - Validates uploaded files:
     - Maximum 3 files
     - Maximum 10MB per file
     - Allowed types: PDF, DOC, DOCX, XLSX, CSV
   - Uploads files to cloud storage: `{company_id}/chat agent/knowledge_base/{chat agent_id}`
   - Creates `Chat AgentKnowledgebase` records (KNOWLEDGEBASE_TYPE: 1 for files)

5. **Text Knowledge Bases:**
   - Processes text-based knowledge bases
   - Creates `Chat AgentKnowledgebase` records (KNOWLEDGEBASE_TYPE: 2 for text)

6. **Change Tracking:**
   - Tracks knowledge base changes

### 6. Calling Numbers

**Function:** `saveChat AgentCallingNumbersHelper(chat agentId, phoneNumbers, auth, transaction)`

**Location:** ```5208:5240:src/controllers/chat agentbuild/chat agentController.js```

**Process:**
1. Removes existing calling numbers for the chat agent
2. For each phone number:
   - Finds provider details by phone number
   - Creates `Chat AgentCallingNumbers` record with:
     - Chat Agent ID
     - Phone number
     - Context ID
     - Number context
     - Call provider ID

### 7. Denied Words

**Function:** `updateChat AgentDeniedWords(req, transaction)`

**Location:** ```5577:5673:src/controllers/chat agentbuild/chat agentController.js```

**Process:**
1. Validates `chat agent_id` is provided
2. Checks chat agent exists and belongs to workspace
3. Processes `denied_words` array (TYPE: 'word')
4. Processes `denied_topics` array (TYPE: 'topic')
5. Creates `Chat AgentDeniedWords` records via bulk create
6. Tracks changes in change history

### 8. Dispositions

**Function:** `dispositionController.createOrUpdateDisposition(req, res, next)`

**Location:** ```2392:2401:src/controllers/chat agentbuild/chat agentController.js```

**Process:**
- Updates chat agent dispositions configuration
- Handled by disposition controller

### 9. Guardrails

**Function:** `guardrailController.createOrUpdateGuardrailSettings(req, res, next)`

**Location:** ```2403:2414:src/controllers/chat agentbuild/chat agentController.js```

**Process:**
- Updates chat agent guardrail settings
- Handled by guardrail controller

### 10. Metadata Configuration

**Function:** `flowhelper.saveChat AgentMetadataConfig(req, transaction)`

**Location:** ```2416:2440:src/controllers/chat agentbuild/chat agentController.js```

**Process:**
1. Processes metadata input array
2. Processes metadata output array
3. Saves chat agent metadata configuration

### 11. Transaction Commit

**Location:** ```2442:2442:src/controllers/chat agentbuild/chat agentController.js```

- Commits database transaction
- All changes are persisted

### 12. Chat Agent Sync

**Function:** `syncChat Agent(auth, req, chat agentId)`

**Location:** ```548:597:src/controllers/chat agentbuild/chat agentController.js```

**Process:**
1. Retrieves chat agent token
2. Calls `chat agentKnowledgeBaseUpdate` to sync knowledge base with AI service
3. For chat agent type 3 (Telephony), calls external chat agent API
4. Syncs chat agent configuration with AI service

**Note:** Sync operations run asynchronously after transaction commit to avoid blocking the response

## Database Tables Involved

1. **Chat AgentDetails** - Main chat agent information
2. **Chat AgentConfiguration** - Chat Agent abilities and settings
3. **Chat AgentKnowledgebase** - Knowledge base files and text
4. **Chat AgentAppTools** - Tools and sub-chat agents
5. **Chat AgentCallingNumbers** - Phone numbers associated with chat agent
6. **Chat AgentDeniedWords** - Denied words and topics
7. **Chat AgentDispositions** - Disposition configurations
8. **Chat AgentGuardrails** - Guardrail settings
9. **Chat AgentMetadata** - Metadata input/output configurations
10. **ChangeHistory** - Tracks all changes made to chat agents

## External Integrations

### 1. AI Service Knowledge Base Sync

- **Endpoint:** `${process.env.AI_SOURCE_BASE_URL}/knowledge-base/update`
- **Purpose:** Syncs knowledge base files with AI service
- **Trigger:** After knowledge base update

### 2. AI Service Chat Agent Sync

- **Endpoint:** `${process.env.AI_BASE_URL}/chat/api/sync-knowledgebase`
- **Purpose:** Syncs chat agent configuration with AI service
- **Trigger:** After chat agent creation/update

### 3. External Chat Agent API (Type 3 Chat Agents)

- **Purpose:** Updates chat agent metadata for telephony chat agents
- **Trigger:** For chat agent type 3 (Telephony)

## Error Handling

1. **Transaction Rollback:**
   - If any error occurs, the entire transaction is rolled back
   - All database changes are reverted

2. **Validation Errors:**
   - Missing required fields throw validation errors
   - Invalid file types/sizes throw errors
   - Non-existent chat agents throw errors

3. **Change Tracking Errors:**
   - Change tracking errors are logged but don't break the main operation
   - Chat Agent creation/update continues even if tracking fails

4. **Sync Errors:**
   - Sync operations run asynchronously
   - Errors in sync don't affect the main operation
   - Errors are logged for debugging

## Response

**Success Response:**

```json
{
  "message": "Chat Agent updated successfully",
  "data": {
    "chat agent_id": 123
  }
}
```

**Error Response:**
- Returns error through Express error handler
- Transaction is rolled back
- Error details are logged

## Key Features

1. **Atomic Operations:** All operations are wrapped in a database transaction
2. **Change Tracking:** All changes are tracked in change history
3. **File Upload Support:** Supports chatbot images and knowledge base files
4. **Flexible Updates:** Can update individual sections or complete chat agent
5. **Name Deduplication:** Automatically handles duplicate chat agent names
6. **Default Values:** Sets sensible defaults for missing fields
7. **Async Sync:** Chat Agent sync happens asynchronously after commit

## Code References

### Main Entry Point

```2315:2461:src/controllers/chat agentbuild/chat agentController.js
module.exports.createOrUpdateCompleteChat Agent = async (req, res, next) => {
  // Main chat agent creation/update handler
}
```

### Basic Details Handler

```177:509:src/controllers/chat agentbuild/chat agentController.js
const createOrUpdateChat Agent = async (req, transaction) => {
  // Handles chat agent basic details creation/update
}
```

### Configuration Handler

```606:850:src/controllers/chat agentbuild/chat agentController.js
const updateChat AgentConfig = async (req, transaction) => {
  // Handles chat agent configuration
}
```

### Knowledge Base Handler

```858:1205:src/controllers/chat agentbuild/chat agentController.js
const updateChat AgentKnowledgebase = async (req, transaction) => {
  // Handles knowledge base updates
}
```

## Notes

- All operations require Super Admin authentication
- Chat Agent ID is required for updates, optional for creation
- Knowledge base files are limited to 3 files, 10MB each
- Supported file types: PDF, DOC, DOCX, XLSX, CSV
- Chat Agent sync happens asynchronously after successful creation/update
- Change history is tracked for audit purposes
